<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Boletas - Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --sidebar-bg: #2c3e50; 
            --orange: #e67e22; 
            --blue: #3498db; 
            --red: #e74c3c; 
            --green: #27ae60;
            --bg-gray: #ecf0f1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg-gray); display: flex; min-height: 100vh; }

        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 20px 0; display: flex; flex-direction: column; position: fixed; height: 100%; }
        .sidebar-header { text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        
        .nav-links { list-style: none; margin-top: 10px; }
        .nav-link a { display: flex; align-items: center; gap: 10px; padding: 15px 25px; color: #bdc3c7; text-decoration: none; transition: 0.3s; border-left: 4px solid transparent; }
        .nav-link a:hover, .nav-link a.active { background: rgba(255,255,255,0.1); color: white; border-left-color: var(--orange); }
        .nav-link i { width: 25px; text-align: center; }

        .sidebar-footer { margin-top: auto; padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .btn-logout { display: flex; align-items: center; gap: 10px; color: var(--red); text-decoration: none; font-weight: bold; padding: 10px; border-radius: 5px; transition: 0.3s; cursor: pointer; }
        .btn-logout:hover { background: rgba(231, 76, 60, 0.1); }

        .main { margin-left: 260px; flex: 1; padding: 30px; }

        .profile-header { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-left: 5px solid var(--blue); }
        .user-info h2 { color: var(--sidebar-bg); margin: 0 0 5px 0; font-size: 1.5rem; text-transform: uppercase; }
        .user-details span { background: #f0f2f5; padding: 4px 10px; border-radius: 4px; font-size: 0.9rem; color: #666; font-weight: bold; margin-right: 10px; }
        
        .btn-back { background: #95a5a6; color: white; text-decoration: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-back:hover { background: #7f8c8d; transform: translateY(-2px); }

        .docs-card { background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px 20px; text-align: left; color: var(--sidebar-bg); font-weight: bold; border-bottom: 2px solid #eee; }
        td { padding: 15px 20px; border-bottom: 1px solid #eee; color: #555; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fcfcfc; }

        .badge-date { background: #e8f4fd; color: var(--blue); padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
        
        .action-btn { border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; transition: 0.2s; margin-right: 5px; }
        .btn-download { background: #eafaf1; color: var(--green); }
        .btn-download:hover { background: var(--green); color: white; }
        .btn-delete-doc { background: #fdeaea; color: var(--red); }
        .btn-delete-doc:hover { background: var(--red); color: white; }
        .empty-state { padding: 40px; text-align: center; color: #7f8c8d; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-shield-alt"></i> ADMIN PANEL
        </div>
        <ul class="nav-links">
            <li class="nav-link"><a href="admin-panel.html"><i class="fas fa-users"></i> Trabajadores</a></li>
            <li class="nav-link"><a href="subir-boletas.html"><i class="fas fa-file-upload"></i> Subir Boletas</a></li>
            <li class="nav-link"><a href="admin-perfil.html"><i class="fas fa-user-cog"></i> Mi Perfil Admin</a></li>
        </ul>
        <div class="sidebar-footer">
            <a href="javascript:void(0)" class="btn-logout" onclick="cerrarSesion()">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi칩n
            </a>
        </div>
    </nav>

    <main class="main">
        <div class="profile-header">
            <div class="user-info">
                <h2 id="userName">Cargando...</h2>
                <div class="user-details">
                    <span id="userDni"><i class="far fa-id-card"></i> ...</span>
                    <span id="userCargo"><i class="fas fa-hard-hat"></i> ...</span>
                </div>
            </div>
            <a href="admin-panel.html" class="btn-back">
                <i class="fas fa-arrow-left"></i> Volver
            </a>
        </div>

        <div class="docs-card">
            <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin:0; color:var(--sidebar-bg);">游늭 Historial de Documentos</h3>
                <small style="color:#7f8c8d">Archivos disponibles para descargar</small>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Periodo</th>
                        <th>Nombre del Archivo</th>
                        <th>Fecha de Subida</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="boletasList">
                    <tr><td colspan="4" style="text-align:center; padding: 2rem;">Cargando documentos...</td></tr>
                </tbody>
            </table>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ezgswcgsgxwskofhcorc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6Z3N3Y2dzZ3h3c2tvZmhjb3JjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NzMwMTEsImV4cCI6MjA3OTM0OTAxMX0.qQM7va7uKQkMaGw0LLnYujNh3U2YsxF0THlRhv1_sXk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('userId');

        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. SEGURIDAD ADMIN BLINDADA ---
            let admin = null;
            try { admin = JSON.parse(localStorage.getItem('usuarioLogueado')); } catch(e) {}

            if (!admin || !admin.es_admin) {
                document.body.innerHTML = `
                    <div style="display:flex;justify-content:center;align-items:center;height:100vh;width:100%;flex-direction:column;font-family:sans-serif;background:#ecf0f1">
                        <h2 style="color:#2c3e50">游 Acceso Restringido</h2>
                        <br>
                        <a href="index.html" style="padding:12px 24px;background:#3498db;color:white;text-decoration:none;border-radius:5px;font-weight:bold">Ir al Login</a>
                    </div>`;
                return;
            }

            // --- 2. VALIDAR URL ---
            if(!userId) {
                alert("No se especific칩 un trabajador.");
                window.location.href = 'admin-panel.html';
                return;
            }

            await cargarInfoUsuario();
            await cargarBoletas();
        });

        async function cargarInfoUsuario() {
            const { data, error } = await supabase.from('trabajadores').select('*').eq('id', userId).single();
            if(data) {
                document.getElementById('userName').textContent = data.nombre;
                document.getElementById('userDni').innerHTML = `<i class="far fa-id-card"></i> ${data.dni}`;
                document.getElementById('userCargo').innerHTML = `<i class="fas fa-hard-hat"></i> ${data.cargo || 'Sin Cargo'}`;
            } else {
                document.getElementById('userName').textContent = "Usuario no encontrado";
            }
        }

        async function cargarBoletas() {
            const tbody = document.getElementById('boletasList');
            const { data, error } = await supabase
                .from('boletas')
                .select('id, mes, a침o, nombre_archivo, url_archivo, fecha_subida')
                .eq('trabajador_id', userId)
                .order('a침o', { ascending: false })
                .order('fecha_subida', { ascending: false });

            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="empty-state"><i class="fas fa-folder-open fa-2x" style="margin-bottom:10px"></i><br>Este trabajador no tiene boletas cargadas a칰n.</td></tr>`;
                return;
            }

            data.forEach(b => {
                const tr = document.createElement('tr');
                const fecha = new Date(b.fecha_subida).toLocaleDateString();
                tr.innerHTML = `
                    <td><span class="badge-date">${b.mes} ${b.a침o}</span></td>
                    <td><i class="fas fa-file-pdf" style="color:#e74c3c; margin-right:5px;"></i> ${b.nombre_archivo}</td>
                    <td style="color: #7f8c8d;">${fecha}</td>
                    <td>
                        <button class="action-btn btn-download" onclick="window.open('${b.url_archivo}', '_blank')" title="Ver"><i class="fas fa-download"></i></button>
                        <button class="action-btn btn-delete-doc" onclick="eliminarBoleta('${b.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        async function eliminarBoleta(id) {
            const confirm = await Swal.fire({ title: '쮼liminar boleta?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S칤, borrar' });
            if (confirm.isConfirmed) {
                await supabase.from('boletas').delete().eq('id', id);
                Swal.fire({ title: 'Eliminado', icon: 'success', timer: 1000, showConfirmButton: false });
                cargarBoletas();
            }
        }

        function cerrarSesion() {
            localStorage.clear();
            // Recarga segura para evitar error de redirecci칩n
            location.reload();
        }
    </script>
</body>
</html>