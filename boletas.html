<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Boletas - SmartBoleta</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --light-bg: #ecf0f1; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--light-bg); min-height: 100vh; display: flex; }

        .sidebar { width: 250px; background: var(--primary); color: white; padding: 20px 0; display: flex; flex-direction: column; position: fixed; height: 100%; }
        .sidebar-header { text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-link { display: flex; align-items: center; gap: 1rem; padding: 1rem 2rem; color: white; text-decoration: none; transition:0.3s; }
        .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.1); border-left: 4px solid var(--accent); }
        .btn-logout { margin-top: auto; padding: 1rem 2rem; color: #e74c3c; text-decoration: none; font-weight: bold; }

        .main-content { margin-left: 250px; flex: 1; padding: 30px; }
        
        .boleta-card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid var(--accent); }
        .boleta-info h3 { margin: 0 0 5px 0; color: var(--primary); text-transform: uppercase; }
        .boleta-info p { margin: 0; color: #7f8c8d; font-size: 0.9rem; }
        
        .btn-download { padding: 10px 20px; background: #27ae60; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-download:hover { background: #219150; transform: translateY(-2px); }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">游눑 SMART BOLETA</div>
        <a href="dashboard.html" class="nav-link">游 Inicio</a>
        <a href="boletas.html" class="nav-link active">游늯 Mis Boletas</a>
        <a href="perfil.html" class="nav-link">游녻 Mi Perfil</a>
        <a href="javascript:void(0)" class="btn-logout" onclick="cerrarSesion()">游뛁 Salir</a>
    </nav>

    <main class="main-content">
        <h2 style="color:var(--primary); margin-bottom:20px">游늭 Mis Recibos de Pago</h2>
        <div id="listaBoletas">
            <p style="text-align:center; color:#7f8c8d">Cargando...</p>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ezgswcgsgxwskofhcorc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV6Z3N3Y2dzZ3h3c2tvZmhjb3JjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NzMwMTEsImV4cCI6MjA3OTM0OTAxMX0.qQM7va7uKQkMaGw0LLnYujNh3U2YsxF0THlRhv1_sXk';
        
        // --- CAMBIO PARA EVITAR ERRORES: Usamos clienteBoletas ---
        const clienteBoletas = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', async () => {
            let u = null;
            
            // --- 1. VERIFICACI칍N SEGURA ---
            try {
                u = JSON.parse(localStorage.getItem('usuarioLogueado'));
                if(!u) throw new Error("No login");
            } catch (e) {
                // Si no hay usuario, mostramos mensaje en vez de redirigir bruscamente
                document.body.innerHTML = `
                    <div style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;font-family:sans-serif">
                        <h2>游 Sesi칩n Expirada</h2>
                        <p>Por favor ingresa nuevamente.</p>
                        <br>
                        <a href="index.html" style="padding:10px 20px;background:#2c3e50;color:white;text-decoration:none;border-radius:5px">Ir al Login</a>
                    </div>`;
                return;
            }

            // --- 2. CARGAR DATOS (Usando clienteBoletas) ---
            const { data } = await clienteBoletas.from('boletas')
                .select('mes, a침o, nombre_archivo, url_archivo, fecha_subida')
                .eq('dni', u.dni)
                .order('a침o', {ascending:false})
                .order('fecha_subida', {ascending:false});

            const div = document.getElementById('listaBoletas');
            div.innerHTML = '';
            
            if(!data || data.length===0) { 
                div.innerHTML = '<p style="text-align:center; padding:20px">No tienes boletas registradas a칰n.</p>'; 
                return; 
            }

            data.forEach(b => {
                const c = document.createElement('div');
                c.className = 'boleta-card';
                c.innerHTML = `
                    <div class="boleta-info">
                        <h3>${b.mes} ${b.a침o}</h3>
                        <p>游늯 ${b.nombre_archivo}</p>
                    </div>
                    <a href="${b.url_archivo}" target="_blank" class="btn-download">
                        拘勇 Descargar PDF
                    </a>`;
                div.appendChild(c);
            });
        });

        function cerrarSesion() {
            localStorage.clear();
            // Intento seguro de ir al login
            try { window.location.href = 'index.html'; }
            catch(e) { document.body.innerHTML = 'Sesi칩n cerrada. Recarga la p치gina.'; }
        }
    </script>
</body>
</html>